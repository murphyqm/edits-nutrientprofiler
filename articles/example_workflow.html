<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="nutrientprofiler">
<title>Example HPC workflow and troubleshooting • nutrientprofiler</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example HPC workflow and troubleshooting">
<meta property="og:description" content="nutrientprofiler">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">nutrientprofiler</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/nutrientprofiler.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/example_workflow.html">Example HPC workflow and troubleshooting</a>
    <a class="dropdown-item" href="../articles/nutrientprofile_assessment.html">Nutrient Profile Model Assessment</a>
    <a class="dropdown-item" href="../articles/nutrientprofile_scoring.html">Nutrient Profile Model Scoring</a>
    <a class="dropdown-item" href="../articles/specific_gravity.html">Specific Gravity Adjustment</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Leeds-CDRC/nutrientprofiler/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<link href="example_workflow_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="example_workflow_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="example_workflow_files/d3-3.3.8/d3.min.js"></script><script src="example_workflow_files/dagre-0.4.0/dagre-d3.min.js"></script><link href="example_workflow_files/mermaid-0.3.0/dist/mermaid.css" rel="stylesheet">
<script src="example_workflow_files/mermaid-0.3.0/dist/mermaid.slim.min.js"></script><link href="example_workflow_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="example_workflow_files/chromatography-0.1/chromatography.js"></script><script src="example_workflow_files/DiagrammeR-binding-1.0.11/DiagrammeR.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Example HPC workflow and troubleshooting</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Leeds-CDRC/nutrientprofiler/blob/HEAD/vignettes/example_workflow.Rmd" class="external-link"><code>vignettes/example_workflow.Rmd</code></a></small>
      <div class="d-none name"><code>example_workflow.Rmd</code></div>
    </div>

    
    
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><p>This vignette walks you through a variety of different installation
options and workflows for analysing data in bulk on a high performance
computing (HPC) platform.</p>
<div class="section level2">
<h2 id="loading-package-onto-an-airgapped-hpc-system">Loading package onto an “airgapped” HPC system<a class="anchor" aria-label="anchor" href="#loading-package-onto-an-airgapped-hpc-system"></a>
</h2>
<p>If working on a secure or “airgapped” system without internet access,
using the R <code>remotes</code> package to install
<code>nutrientprofiler</code> will not work.</p>
<p>Instead, if there is a file/data transfer process available, the
zipped package can be transferred to the secure computational platform
and installed locally.</p>
<p>This process can be broken down into 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Downloading the package/zipped archive to your local system</li>
<li>Transferring the files to the secure system (after any required
security checks)</li>
<li>Installing without internet access on the secure system.</li>
</ol>
<p>The instructions here assume access to some form of archived CRAN
mirror so that other commonly used packages are available. Please check
through the packages listed in the code snippets and ensure you have
access to these on your system.</p>
<div class="section level3">
<h3 id="downloading-the-package-to-your-local-machine">1. Downloading the package to your local machine<a class="anchor" aria-label="anchor" href="#downloading-the-package-to-your-local-machine"></a>
</h3>
<p>You can download a specific tagged release (see the <a href="https://github.com/Leeds-CDRC/nutrientprofiler/releases" class="external-link">GitHub
releases</a> page) or a development pre-release version of the code from
a specific branch of the repository.</p>
<p>Tagged releases allow for better reproducibility; however, if a
pre-release version needs to be used, reproducibility can still be
ensured by recording the download link used and the access date.</p>
<div class="section level4">
<h4 id="downloading-a-tagged-release">1.1 Downloading a tagged release<a class="anchor" aria-label="anchor" href="#downloading-a-tagged-release"></a>
</h4>
<p><strong>The recommended method is to download the most recent tagged
release as a <code>.tar.gz</code> archive.</strong></p>
<p>From your local desktop you can run the following R snippet to
download the <code>v1.0.0</code> release of the package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># download the v1.0.0 release as a .tar.gz archive</span></span>
<span><span class="co"># to your current directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://github.com/Leeds-CDRC/nutrientprofiler/archive/refs/tags/v1.0.0.tar.gz"</span>,</span>
<span>              dest <span class="op">=</span> <span class="st">"./nutrientprofiler-v1.0.0.tar.gz"</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, this can be downloaded directly from the <a href="https://github.com/Leeds-CDRC/nutrientprofiler/releases" class="external-link">GitHub
releases</a> page.</p>
<p>A different release can be specified by changing the release tag.
Make sure to also update the destination filename to prevent
confusion:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># replace &lt;tag&gt; with the required version number</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://github.com/Leeds-CDRC/nutrientprofiler/archive/refs/tags/&lt;tag&gt;.tar.gz"</span>,</span>
<span>              dest <span class="op">=</span> <span class="st">"./nutrientprofiler-&lt;tag&gt;.tar.gz"</span><span class="op">)</span></span></code></pre></div>
<p>If required, zip file archives are also available on the <a href="https://github.com/Leeds-CDRC/nutrientprofiler/releases" class="external-link">GitHub
releases</a> page or can be downloaded using the following R script
below. Please note that these <code>.zip</code> archives require a
slightly different installation to <code>.tar.gz</code>; please read
through the isntallation steps first.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># download the &lt;tag&gt; release as a zip archive</span></span>
<span><span class="co"># to your current directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://github.com/Leeds-CDRC/nutrientprofiler/archive/refs/tags/&lt;tag&gt;.zip"</span>,</span>
<span>              dest <span class="op">=</span> <span class="st">"./nutrientprofiler-&lt;tag&gt;.zip"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="downloading-the-current-development-version-or-a-specific-branch">1.2 Downloading the current development version or a specific
branch<a class="anchor" aria-label="anchor" href="#downloading-the-current-development-version-or-a-specific-branch"></a>
</h4>
<p>If you want to install a pre-release version of a specific version on
a branch, replace <code>tags/version-number</code> in the url with
<code>heads/branch-name</code> (and rename the destination file
something sensible).</p>
<p><strong>Please record the date of download and most recent commit
identifier as the branch may be updated or changed following your
download and installation.</strong></p>
<p>For example, the following downloads the current package on the
“VarEdits” branch of the repository:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># replace "tags/version-number" with "heads/branch-name":</span></span>
<span><span class="co"># in this example, we replaced "tags/v1.0.0" with "heads/VarEdits"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://github.com/Leeds-CDRC/nutrientprofiler/archive/refs/heads/VarEdits.tar.gz"</span>,</span>
<span>              dest <span class="op">=</span> <span class="st">"./nutrientprofiler-VarEdits.tar.gz"</span><span class="op">)</span></span></code></pre></div>
<p>Again, a zip file version can be downloaded by replacing
<code>tar.gz</code> in the snippet above with <code>zip</code>. A zip
file can also be downloaded from the project <a href="https://github.com/Leeds-CDRC/nutrientprofiler" class="external-link">GitHub page</a> by
navigating to the required branch and then using the green “Code” button
to open the “Clone” option menu, and selecting the “Download zip”
option.</p>
</div>
</div>
<div class="section level3">
<h3 id="transferring-your-code-to-the-secure-platform">2. Transferring your code to the secure platform<a class="anchor" aria-label="anchor" href="#transferring-your-code-to-the-secure-platform"></a>
</h3>
<p>This step will vary depending on the data transfer policies and
process enforced by your institution. While the package archive can be
unzipped for testing, it should be saved on the secure system in it’s
original compressed format.</p>
</div>
<div class="section level3">
<h3 id="installation">3. Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>On the secure computing platform, once the archive has been
transferred, you can then install the package. The installation method
differs depending on the filetype.</p>
</div>
<div class="section level3">
<h3 id="install--tar-gz-archives">3.1 Install <code>.tar.gz</code> archives<a class="anchor" aria-label="anchor" href="#install--tar-gz-archives"></a>
</h3>
<p>Using an appropriate relative path for the archive, you can install
it from source:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install the package directly from source</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"./nutrientprofiler-v1.0.0.tar.gz"</span>, repos <span class="op">=</span> <span class="cn">NULL</span>, type<span class="op">=</span><span class="st">"source"</span><span class="op">)</span></span></code></pre></div>
<p>Change the suggested filename to suit your specific installation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install the package directly from source</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"./nutrientprofiler-VarEdits.tar.gz"</span>, repos <span class="op">=</span> <span class="cn">NULL</span>, type<span class="op">=</span><span class="st">"source"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="install--zip-archives">3.2 Install <code>.zip</code> archives<a class="anchor" aria-label="anchor" href="#install--zip-archives"></a>
</h3>
<p>In order to install the package from a <code>.zip</code> file, you
need to use the <code>devtools</code> package:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install and load devtools</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_local</span><span class="op">(</span><span class="st">"./nutrientprofiler-v1.0.0.zip"</span><span class="op">)</span></span></code></pre></div>
<p>Again, chasnge the suggested filename to suit your specific
installation.</p>
<!-- 


The `nutrientprofiler` package aims to provide a series of R functions that 
implement UK Nutrient Profiling Model scoring that can be applied across product 
datasets.

This is broken up into 3 parts within the package: 

- Specific gravity conversions
- Scoring the different nutritional components of the NPM score
- Calculating the NPM score and NPM assessment logic

To start we load the package the with command below.

``` r
library(nutrientprofiler)
```

We can also load some example data to help us with the following examples.
This data was created specifically for this package and so is potentially 
quite different to how your real world data might look.


``` r
dim(cdrcdrinks)
#> [1] 10 21
```

``` r
cdrcdrinks[1, ]
#>     name brand product_category product_type food_type drink_format drink_type
#> 1 lembas    NA               NA         Food                                  
#>   nutrition_info energy_measurement_kj energy_measurement_kcal
#> 1                                  266                      NA
#>   sugar_measurement_g satfat_measurement_g salt_measurement_g
#> 1                  50                    3                 NA
#>   sodium_measurement_mg fibre_measurement_nsp fibre_measurement_aoac
#> 1                   0.6                     3                     NA
#>   protein_measurement_g fvn_measurement_percent weight_g volume_ml
#> 1                     7                       0      100        NA
#>   volume_water_ml
#> 1              NA
```

## Specific gravity conversions

When trying to determine the NPM score the volume or weight of the product needs
to be adjusted to account for it's specific gravity. 

To adjust product weights or volumes for specific gravity we use the `SGConverter`
function. This is a high level function that is designed to operate on each row of 
a data.frame parsing multiple columns to determine how to calculate the adjusted 
specific gravity score.


```{.r .bg-warning}
Warning: The `SGConverter` function has been specifically designed with an
existing dataset in mind and expects specific column names to work.
```


``` r
# using dplyr
library(dplyr)
#> 
#> Attaching package: 'dplyr'
#> The following objects are masked from 'package:stats':
#> 
#>     filter, lag
#> The following objects are masked from 'package:base':
#> 
#>     intersect, setdiff, setequal, union
```

``` r
cdrcdrinks %>%
  rowwise() %>%
  mutate(out = SGConverter(pick(everything()))) %>%
  select(out)
#>  [38;5;246m# A tibble: 10 × 1 [39m
#>  [38;5;246m# Rowwise:  [39m
#>      out
#>     [3m [38;5;246m<dbl> [39m [23m
#>  [38;5;250m 1 [39m 100  
#>  [38;5;250m 2 [39m 130  
#>  [38;5;250m 3 [39m 104  
#>  [38;5;250m 4 [39m 129. 
#>  [38;5;250m 5 [39m 103  
#>  [38;5;250m 6 [39m 100  
#>  [38;5;250m 7 [39m  51.5
#>  [38;5;250m 8 [39m  25  
#>  [38;5;250m 9 [39m 124. 
#>  [38;5;250m10 [39m 109
```

``` r

# using base R
cdrcdrinks["sg"] <- unlist(lapply(seq_len(nrow(cdrcdrinks)), function(i) SGConverter(cdrcdrinks[i, ])))
```

The below figure attempts to outline the hierarchy of function calls that `SGConverter` 
initiates. The logic for determining how to adjust values for specific gravity is 
complicated by the potential options around whether a drink is ready-to-drink,
a powdered preparation, or a cordial, within both the powdered and cordial options
additional consideration must be given to the preparation instructions that are provided.
In the below figure each function is named in each node and each column name the function 
uses to dispatch to underlying functions is specified in single quotes. If a function returns
a value it is marked with an empty diamond.

<div class="figure" style="text-align: center">

```{=html}
<div class="DiagrammeR html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:960px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"\ngraph TB;\n  1(SGConverter<br>'product_type') -->
<p>2(sg_food_converter<br>‘weight_g’); –&gt;
3(sg_drink_converter<br>‘drink_format’); –&gt;
4(sg_ready_drink_converter<br>‘drink_type’); –&gt;
5(sg_powd_drink_converter<br>‘nutrition_info’); –&gt;
6(sg_cord_drink_converter<br>‘nutrition_info’); –&gt; 7{ }; –&gt; 10{ };
–&gt; 11(sg_liquidfood_converter<br>‘food_type’); –&gt; 13{ }; –&gt; 14{
}; –&gt; 16{ };“},”evals”:[],“jsHooks”:[]}</p>
<pre><code>
&lt;p class="caption"&gt;SGConverter logic&lt;/p&gt;
&lt;/div&gt;

## Nutrient profile model scoring

The next part of this package is a series of functions for handling Nutrient
Profile Model scoring. These specifically look at functions for adjusting units
into the expected unit as documented for the [Nutrient Profile
Model](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/216094/dh_123492.pdf),
a generic scoring function for returning a score for a value given a number of
thresholds, a scoring dispatcher function that determines what adjuster and
scoring thresholds to use for a given value and a high level `NPMScore` wrapper
function that shows the logic for calculating the NPM score across multiple
nutritional groups for a data.frame of data.

A quick example of running `NPMScore` across a single row of data is shown below:

``` r
NPMScore(cdrcdrinks[1,], sg_adjusted_label="sg")
#&gt;   energy_score sugar_score satfat_score protein_score salt_score fvn_score
#&gt; 1            0          10            2             4          0         0
#&gt;   fibre_score
#&gt; 1           4</code></pre>
<p>An example of building a tidyverse pipeline to calculate scores
across all rows of a data.frame using <code>NPMScore</code> and
<code>SGConverter</code> is shown below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdrcdrinks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span> sg <span class="op">=</span> <span class="fu"><a href="../reference/SGConverter.html">SGConverter</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>test <span class="op">=</span> <span class="fu"><a href="../reference/NPMScore.html">NPMScore</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, sg_adjusted_label<span class="op">=</span><span class="st">"sg"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="va">energy_score</span>, <span class="va">sugar_score</span>, <span class="va">salt_score</span>, <span class="va">fvn_score</span>,</span>
<span>  <span class="va">protein_score</span>, <span class="va">satfat_score</span>, <span class="va">fibre_score</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 7</span></span></span>
<span><span class="co">#&gt;    energy_score sugar_score salt_score fvn_score protein_score satfat_score</span></span>
<span><span class="co">#&gt;           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>            0          10          0         0             4            2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>            0           3          0         0             1            8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>            2           2          1         0             0            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>            0           2          0         0             0            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>            2           4          0         0             0            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>            0           4          0         0             2           10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>            1           6          2         0             0            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>            2          10          4         0             1            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>            2           3          0         0             0            0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>            2           3          0         0             0            0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: fibre_score &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="nutrient-profile-model-assessment">Nutrient Profile Model assessment<a class="anchor" aria-label="anchor" href="#nutrient-profile-model-assessment"></a>
</h2>
<p>After calculating the scores for specific nutrients for our product
next we need to perform the actual Nutrient Profile Model assessment.
This involves combining individual nutrient scores to calculate an A
score and a C score and use these compound to calculate a total Nutrient
Profile Model score and assess this to determine a pass or fail.</p>
<p>This package implements this logic in a high-level wrapper function
called <code>NPMAssess</code> which operates on a row of a data.frame.
It expects the columns generated in the previous <code>NPMScore</code>
step to allow it to calculate the A score and C score and can be used as
follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create NPM_score data.frame from NPMScore</span></span>
<span><span class="co"># using the specific gravity `sg` column created above</span></span>
<span><span class="va">npm_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>        <span class="st">"rbind"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cdrcdrinks</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="../reference/NPMScore.html">NPMScore</a></span><span class="op">(</span><span class="va">cdrcdrinks</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>, sg_adjusted_label <span class="op">=</span> <span class="st">"sg"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># append NPM Score columns to original data</span></span>
<span><span class="va">combo_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cdrcdrinks</span>, <span class="va">npm_scores</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># test NPMAssess on this data</span></span>
<span><span class="fu"><a href="../reference/NPMAssess.html">NPMAssess</a></span><span class="op">(</span><span class="va">combo_df</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A_score C_score NPM_score NPM_assessment</span></span>
<span><span class="co">#&gt; 1      12       8         8           FAIL</span></span></code></pre></div>
<p>We can also use tidyverse functions to build an entire pipeline for
running Nutrient Profile Model assessments.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># using tidyr</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdrcdrinks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span> sg <span class="op">=</span> <span class="fu"><a href="../reference/SGConverter.html">SGConverter</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>test <span class="op">=</span> <span class="fu"><a href="../reference/NPMScore.html">NPMScore</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, sg_adjusted_label<span class="op">=</span><span class="st">"sg"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>assess <span class="op">=</span> <span class="fu"><a href="../reference/NPMAssess.html">NPMAssess</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">assess</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">product_type</span>, <span class="va">NPM_score</span>, <span class="va">NPM_assessment</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 3</span></span></span>
<span><span class="co">#&gt;    product_type NPM_score NPM_assessment</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Food                 8 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Food                11 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Drink                5 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Drink                2 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Drink                6 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Food                14 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Drink                9 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Drink               16 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Drink                5 FAIL          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Drink                5 FAIL</span></span></code></pre></div>
<p>The building blocks of <code>NPMAssess</code> are explained in more
detail in the <a href="./nutrientprofile_assessment.Rmd">Nutrient
Profile Model Assessment vignette</a> –&gt;</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alex Coleman, Vicki Jenneson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
